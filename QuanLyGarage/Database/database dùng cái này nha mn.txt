USE [master]
GO

/****** Object:  Database [QuanLyGarage]    Script Date: 5/31/2023 11:3:32 PM ******/
CREATE DATABASE [QuanLyGarage]
 CONTAINMENT = NONE
 ON  PRIMARY 
( NAME = N'QuanLyGarage', FILENAME = N'E:\QuanLyGarage.mdf' , SIZE = 8192KB , MAXSIZE = UNLIMITED, FILEGROWTH = 65536KB )
 LOG ON 
( NAME = N'QuanLyGarage_log', FILENAME = N'E:\QuanLyGarage_log.ldf' , SIZE = 8192KB , MAXSIZE = 2048GB , FILEGROWTH = 65536KB )
GO

ALTER DATABASE [QuanLyGarage] SET COMPATIBILITY_LEVEL = 140
GO
IF (1 = FULLTEXTSERVICEPROPERTY('IsFullTextInstalled'))
begin
EXEC [QuanLyGarage].[dbo].[sp_fulltext_database] @action = 'enable'
end
GO
ALTER DATABASE [QuanLyGarage] SET ANSI_NULL_DEFAULT OFF 
GO
ALTER DATABASE [QuanLyGarage] SET ANSI_NULLS OFF 
GO
ALTER DATABASE [QuanLyGarage] SET ANSI_PADDING OFF 
GO
ALTER DATABASE [QuanLyGarage] SET ANSI_WARNINGS OFF 
GO
ALTER DATABASE [QuanLyGarage] SET ARITHABORT OFF 
GO
ALTER DATABASE [QuanLyGarage] SET AUTO_CLOSE OFF 
GO
ALTER DATABASE [QuanLyGarage] SET AUTO_SHRINK OFF 
GO
ALTER DATABASE [QuanLyGarage] SET AUTO_UPDATE_STATISTICS ON 
GO
ALTER DATABASE [QuanLyGarage] SET CURSOR_CLOSE_ON_COMMIT OFF 
GO
ALTER DATABASE [QuanLyGarage] SET CURSOR_DEFAULT  GLOBAL 
GO
ALTER DATABASE [QuanLyGarage] SET CONCAT_NULL_YIELDS_NULL OFF 
GO
ALTER DATABASE [QuanLyGarage] SET NUMERIC_ROUNDABORT OFF 
GO
ALTER DATABASE [QuanLyGarage] SET QUOTED_IDENTIFIER OFF 
GO
ALTER DATABASE [QuanLyGarage] SET RECURSIVE_TRIGGERS OFF 
GO
ALTER DATABASE [QuanLyGarage] SET  DISABLE_BROKER 
GO
ALTER DATABASE [QuanLyGarage] SET AUTO_UPDATE_STATISTICS_ASYNC OFF 
GO
ALTER DATABASE [QuanLyGarage] SET DATE_CORRELATION_OPTIMIZATION OFF 
GO
ALTER DATABASE [QuanLyGarage] SET TRUSTWORTHY OFF 
GO
ALTER DATABASE [QuanLyGarage] SET ALLOW_SNAPSHOT_ISOLATION OFF 
GO
ALTER DATABASE [QuanLyGarage] SET PARAMETERIZATION SIMPLE 
GO
ALTER DATABASE [QuanLyGarage] SET READ_COMMITTED_SNAPSHOT OFF 
GO
ALTER DATABASE [QuanLyGarage] SET HONOR_BROKER_PRIORITY OFF 
GO
ALTER DATABASE [QuanLyGarage] SET RECOVERY FULL 
GO
ALTER DATABASE [QuanLyGarage] SET  MULTI_USER 
GO
ALTER DATABASE [QuanLyGarage] SET PAGE_VERIFY CHECKSUM  
GO
ALTER DATABASE [QuanLyGarage] SET DB_CHAINING OFF 
GO
ALTER DATABASE [QuanLyGarage] SET FILESTREAM( NON_TRANSACTED_ACCESS = OFF ) 
GO
ALTER DATABASE [QuanLyGarage] SET TARGET_RECOVERY_TIME = 60 SECONDS 
GO
ALTER DATABASE [QuanLyGarage] SET DELAYED_DURABILITY = DISABLED 
GO
EXEC sys.sp_db_vardecimal_storage_format N'QuanLyGarage', N'ON'
GO
ALTER DATABASE [QuanLyGarage] SET QUERY_STORE = OFF
GO
USE [QuanLyGarage]
GO

/****** Object:  Table [dbo].[QUYDINH]    Script Date: 5/31/2023 11:12:32 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[THAMSO]
(
	[MaThamSo] [int] IDENTITY(1,1),
	[TenThamSo] [varchar](5) NOT NULL,
	[GiaTri] [int] NOT NULL,
	PRIMARY KEY CLUSTERED
	(
		[MaThamSo] ASC
	)
	WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO

/****** Object: Table [dbo].[KHACHHANG]		Scripyt Date: 5/31/2023 24:4:4 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[KHACHHANG]
(
	[MaKH] [int] IDENTITY(1,1),
	[TenKH] [varchar](50) NOT NULL,
	[DienThoai] [varchar](50) NOT NULL,
	[DiaChi] [varchar](100) NOT NULL,
	[TienNo] [money] NOT NULL DEFAULT 0,
	PRIMARY KEY  CLUSTERED
	(
		[MaKH] ASC
	)
	WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]	
) ON [PRIMARY]
GO

/****** Object: Table [dbo].[TAIKHOAN]		Scripyt Date: 5/31/2023 24:4:4 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TAIKHOAN]
(
	[MaTK] [int] IDENTITY(1,1),
	[TenDangNhap] [varchar](20) NOT NULL,
	[MatKhau] [varchar](20) NOT NULL,
	[QuyenHan] [bit] NOT NULL,
	PRIMARY KEY  CLUSTERED
	(
		[MaTK] ASC
	)
	WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]	
) ON [PRIMARY]
GO

/****** Object: Table [dbo].[XE]		Scripyt Date: 5/31/2023 34:4:4 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[XE]
(
	[BienSo] [varchar](10) NOT NULL,
	[MaKH] [int] NOT NULL,
	[HieuXe] [varchar](50) NOT NULL,
	[NgayTiepNhan] [datetime] NULL,
	[TrangThai] [int] DEFAULT 1,  ---- 1 là xe vẫn còn trong garage, còn lại là không còn
	PRIMARY KEY CLUSTERED
	(
		[BienSo] ASC
	)
	WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]	
) ON [PRIMARY]
GO

/****** Object: Table [dbo].[KHO]		Scripyt Date: 5/31/2023 34:4:4 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[KHO]
(
	[MaPhuTung] [int] IDENTITY(1,1),
	[TenVatTuPhuTung] [varchar](50) NOT NULL,
	[SoLuong] [int] NOT NULL,
	[DonGia] [money] NOT NULL,
	PRIMARY KEY CLUSTERED 
	(
		[MaPhuTung] ASC
	)
	WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]	
) ON [PRIMARY]
GO

/****** Object: Table [dbo].[TIENCONG]		Scripyt Date: 5/31/2023 34:4:4 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TIENCONG]
(
	[MaTC] [int] IDENTITY(1,1),
	[TenTienCong] [varchar](50) NOT NULL,
	[ChiPhi] [money] NOT NULL,
	PRIMARY KEY CLUSTERED 
	(
		[MaTC] ASC
	)
	WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]	
) ON [PRIMARY]
GO

/****** Object: Table [dbo].[PHIEUSUACHUA]		Scripyt Date: 5/31/2023 34:4:4 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PHIEUSUACHUA]
(
	[MaPhieuSuaChua] [int] IDENTITY(1,1),
	[BienSo] [varchar](10) NOT NULL,
	[MaKH] [int] NOT NULL,
	[TienCong] [int]  NOT NULL,
	[TienPhuTung] [int] NOT NULL,
	[TongTien] [money] NOT NULL
	PRIMARY KEY CLUSTERED
	(
		[MaPhieuSuaChua] ASC
	)
	WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]	
) ON [PRIMARY]
GO

/****** Object: Table [dbo].[CT_PHIEUSUACHUA]		Scripyt Date: 5/31/2023 34:4:4 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[CT_PHIEUSUACHUA]
(
	[MaPhieuSuaChua] [int] IDENTITY(1,1),
	[MaTC] [int] NOT NULL,
	[MaPhuTung] [int] NOT NULL,
	CONSTRAINT [PK_CTPSC] PRIMARY KEY CLUSTERED
	(
		[MaPhieuSuaChua] ASC,
		[MaTC] ASC,
		[MaPhuTung] ASC
	)
	WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]	
) ON [PRIMARY]
GO

/****** Object: Table [dbo].[PHIEUTHUTIEN]		Scripyt Date: 5/31/2023 34:4:4 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PHIEUTHUTIEN]
(
	[MaPhieuThuTien] [int] IDENTITY(1,1),
	[MaKH] [int] NOT NULL,
	[TienThu] [money] NOT NULL,
	[NgayThuTien] [datetime] NOT NULL,
	PRIMARY KEY CLUSTERED
	(
		[MaPhieuThuTien] ASC
	)
	WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]	
) ON [PRIMARY]
GO

/****** Object: Table [dbo].[PHIEUNHAPVTPT]		Scripyt Date: 5/31/2023 34:4:4 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PHIEUNHAPVTPT]
(
	[MaPNVTPT] [int] IDENTITY(1,1),
	[MaPhuTung] [int] NOT NULL,
	[SoLuong] [int] NOT NULL,
	[ThoiDiem] [datetime] NOT NULL,
	PRIMARY KEY CLUSTERED
	(
		[MaPNVTPT] ASC
	)
	WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]	
) ON [PRIMARY]
GO

/****** Object: Table [dbo].[BAOCAOTON]		Scripyt Date: 5/31/2023 34:4:4 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BAOCAOTON]
(
	[MaBCT] [int] IDENTITY(1,1),
	[ThoiDiemBaoCao] [datetime] NOT NULL,
	PRIMARY KEY CLUSTERED
	(
		[MaBCT] ASC
	)
	WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]	
) ON [PRIMARY]
GO

/****** Object: Table [dbo].[CT_BAOCAOTON]		Scripyt Date: 5/31/2023 34:4:4 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[CT_BAOCAOTON]
(
	[MaBCT] [int] IDENTITY(1,1),
	[MaPhuTung] [int] NOT NULL,
	[TonDau] [int] NOT NULL,
	[TonCuoi] [int] NOT NULL,
	[PhatSinh] [int] NOT NULL,
	CONSTRAINT [PK_CTBCT] PRIMARY KEY CLUSTERED
	(
		[MaBCT] ASC,
		[MaPhuTung] ASC
	)
	WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]	
) ON [PRIMARY]
GO

INSERT [dbo].[TAIKHOAN]([TenDangNhap], [MatKhau], [QuyenHan]) VALUES ( N'quanly01', N'quanly01', 1)
INSERT [dbo].[TAIKHOAN]([TenDangNhap], [MatKhau], [QuyenHan]) VALUES ( N'quanly02', N'quanly02', 1)
INSERT [dbo].[TAIKHOAN]([TenDangNhap], [MatKhau], [QuyenHan]) VALUES ( N'nhanvien01', N'nhanvien01', 0)
INSERT [dbo].[TAIKHOAN]([TenDangNhap], [MatKhau], [QuyenHan]) VALUES ( N'nhanvien02', N'nhanvien02', 0)

INSERT [dbo].[KHACHHANG]( [TenKH],  [DienThoai],  [DiaChi]) VALUES ( N'Nguyen Tung Duong',  N'0777987601',  N'15/3 A duong Phuoc Hau, xa Phuoc Hong')
INSERT [dbo].[KHACHHANG]( [TenKH],  [DienThoai],  [DiaChi]) VALUES ( N'Dang Khoi Nguyen',  N'0666987601',  N'23/4 B duong Long My, xa Mau Hong')
INSERT [dbo].[KHACHHANG]( [TenKH],  [DienThoai],  [DiaChi]) VALUES ( N'Nguyen Thi My Duyen',  N'0888987601',  N'33/5 A duong Hoa Phat, xa Hong Chau')

INSERT [dbo].[XE]([MaKH], [BienSo], [HieuXe]) VALUES (1, N'001001', N'Toyota')
INSERT [dbo].[XE]([MaKH], [BienSo], [HieuXe]) VALUES (2, N'002002', N'Kia')
INSERT [dbo].[XE]([MaKH], [BienSo], [HieuXe]) VALUES (3, N'003003', N'Suzuki')

INSERT [dbo].[THAMSO]([TenThamSo], [GiaTri]) VALUES ( N'Slqd', 8)
INSERT [dbo].[THAMSO]([TenThamSo], [GiaTri]) VALUES ( N'Slhx', 10)
INSERT [dbo].[THAMSO]([TenThamSo], [GiaTri]) VALUES ( N'Slhx2', 30)
INSERT [dbo].[THAMSO]([TenThamSo], [GiaTri]) VALUES ( N'Slpt', 200)
INSERT [dbo].[THAMSO]([TenThamSo], [GiaTri]) VALUES ( N'Sltc', 100)
INSERT [dbo].[THAMSO]([TenThamSo], [GiaTri]) VALUES ( N'Sltk', 1)
INSERT [dbo].[THAMSO]([TenThamSo], [GiaTri]) VALUES ( N'Slhs', 1)
INSERT [dbo].[THAMSO]([TenThamSo], [GiaTri]) VALUES ( N'Sltd', 5)

ALTER TABLE [dbo].[XE] WITH CHECK ADD FOREIGN KEY ([MaKH]) REFERENCES [dbo].[KHACHHANG]([MaKH])
GO
ALTER TABLE [dbo].[PHIEUSUACHUA] WITH CHECK ADD FOREIGN KEY ([BienSo])  REFERENCES [dbo].[XE](BienSo)
GO
ALTER TABLE [dbo].[PHIEUSUACHUA] WITH CHECK ADD FOREIGN KEY ([MaKH])  REFERENCES [dbo].[KHACHHANG](MaKH)
GO
ALTER TABLE [dbo].[CT_PHIEUSUACHUA] WITH CHECK ADD FOREIGN KEY ([MaPhieuSuaChua]) REFERENCES [dbo].[PHIEUSUACHUA]([MaPhieuSuaChua])
GO
ALTER TABLE [dbo].[CT_PHIEUSUACHUA] WITH CHECK ADD FOREIGN KEY ([MaPhuTung]) REFERENCES [dbo].[KHO]([MaPhuTung])
GO
ALTER TABLE [dbo].[CT_PHIEUSUACHUA] WITH CHECK ADD FOREIGN KEY ([MaTC]) REFERENCES [dbo].[TIENCONG]([MaTC])
GO
ALTER TABLE [dbo].[PHIEUTHUTIEN] WITH CHECK ADD FOREIGN KEY ([MaKH]) REFERENCES [dbo].[KHACHHANG]([MaKH])
GO
ALTER TABLE [dbo].[PHIEUNHAPVTPT] WITH CHECK ADD FOREIGN KEY (MaPhuTung) REFERENCES [dbo].[KHO]([MaPhuTung])
GO
ALTER TABLE [dbo].[CT_BAOCAOTON] WITH CHECK ADD FOREIGN KEY ([MaBCT]) REFERENCES [dbo].[BAOCAOTON]([MaBCT])
GO
ALTER TABLE [dbo].[CT_BAOCAOTON] WITH CHECK ADD FOREIGN KEY ([MaPhuTung]) REFERENCES [dbo].[KHO]([MaPhuTung])
GO

/****** EXEC [dbo].[USP_DangNhap] @TenDN = 'quanly01', @MatKhau = 'quanly01' ******/
/****** UC-1: Đăng nhập: USP_DangNhap ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE	PROCEDURE [dbo].[usp_dangnhap]
	@TenDangNhap varchar(20),
	@MatKhau varchar(20)
AS
BEGIN
	SELECT COUNT(*) as 'Số lượng tài khoản'
	FROM TAIKHOAN
	WHERE @TenDangNhap= TenDangNhap and @MatKhau = MatKhau
	GROUP BY TenDangNhap, MatKhau
END
GO

/******  UC-3: PROCEDURE ThemKhachHang  ******/
/****** EXEC ThemKhachHang @TenKH = 'Tran Minh Duy', @DienThoai = '0985670111', @DiaChi = 'huyen Vung Liem' ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE	PROCEDURE [dbo].[ThemKhachHang]
	@TenKH varchar(50),
	@DienThoai varchar(50),
	@DiaChi varchar(100),
	@TienNo money
AS
BEGIN
	INSERT INTO [dbo].[KHACHHANG]([TenKH], [DienThoai], [DiaChi], [TienNo]) VALUES( @TenKH, @DienThoai, @DiaChi, @TienNo)
END
GO

/******  UC-3: PROCEDURE ThemXe  ******/
/******  EXEC ThemXe @BienSo = '004004', @HieuXe = 'Hyundai' ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE	PROCEDURE [dbo].[ThemXe]
	@BienSo varchar(10),
	@HieuXe varchar(50),
	@NgayTiepNhan datetime = NULL
AS
BEGIN
	DECLARE @MaKH int
	SELECT @MaKH = ISNULL(MAX(MAKH),1) FROM KHACHHANG
	INSERT INTO [dbo].[XE] ( [MaKH], [BienSo], [HieuXe], [NgayTiepNhan]) VALUES (@MaKH, @BienSo, @HieuXe, @NgayTiepNhan)
END
GO

USE [master]
GO
ALTER DATABASE [QuanLyGarage] SET  READ_WRITE 
GO